# 微服务
## 单体应用走向微服务
**服务拆分的两种姿势**
```
1、纵向拆分：从业务纬度进行拆分、标准是按照业务关联程度来决定、关联比较密切的业务适合拆分为一个微服务、而功能相对独立的业务适合拆分为一个微服务
2、横向拆分：是从公共且独立功能纬度拆分，标准按照是否公共的被多个其他服务进行调用，且依赖资源不与其他业务耦合
```
## 初识微服务架构
**微服务架构组成**
```
主要依赖一下组件：
1、服务描述：一般为RESTful API、XML、IDL配置文件，主要描述了这个服务名是啥、调用服务需要提供哪些信息，调用结果返回格式为，如何进行解析
2、注册中心：为外部服务提供调用功能，服务提供者会将自己服务注册至注册中心；工作流程为根据配置的发布信息中的配置文件向注册中心注册自己的服务，服务消费者根据配置文件配置的服务信息向注册中心订阅自己所需的服务；注册中心返回服务提供者地址列表服务消费者；当服务提供者发生变化时，比如节点新增或销毁，注册中心将变更通知给服务消费者
3、服务框架：通过注册中心后，服务消费者可以获取到服务提供者的地址，需要确定采用哪种服务通信框架
4、服务监控：一旦服务消费者与服务提供者调用正常，就可以通过服务监控了解服务是否正常，服务监控有三个流程，指标收集（将请求耗时汇总在一起，上传至数据处理中心）、数据处理（获取到每次耗时后，计算平均耗时）、数据展示（通过Dashboard 展示）
5、服务追踪：服务消费者调用前会生成一个requestid，将requestid传递给服务提供者，服务提供者获取到requestid后会去检查后续是否存在服务调用，若存在将生成一个requestid，将这两个requestid作为参数依次传递
6、服务治理：通过服务治理手段使应用更加健壮
```
**服务如何注册至注册中心**
```
注册中心提供以下基本API：
服务注册接口：服务提供者完成服务注册调用的接口
服务反注册接口：服务提供者服务注销调用的接口
心跳汇报接口：服务提供者发送节点存活上报的接口
服务订阅接口：服务消费者获取服务提供者可用节点调用的接口
服务变更查询接口：服务消费者调用该接口查看是否最新可用服务节点列表
```
## 如何监控服务调用
**监控对象**
```
1、用户端监控：主要监控用户应用的功能模块进行监控
2、接口监控：主要监控用户应用的功能模块依赖的具体RPC接口进行监控
3、资源监控：主要针对某个接口资源服务（redis/mysql）使用率进行监控
4、基础监控：对服务器本身进行健康监控
```
**监控指标**
```
1、请求量：一个是实时请求量，一个是统计请求量。实时请求量用 QPS（Queries Per Second）即每秒查询次数来衡量，它反映了服务调用的实时变化情况。统计请求量一般用 PV（Page View）即一段时间内用户的访问量来衡量，比如一天的 PV 代表了服务一天的请求量，通常用来统计报表
2、相应时间：可以用一段时间内所有调用的平均耗时来反映请求的响应时间，有时候我们更关心慢请求的数量。为此需要把响应时间划分为多个区间
3、错误率：错误率的监控通常用一段时间内调用失败的次数占调用总次数的比率来衡量
```
## 如何追踪服务调用
**服务追踪的作用**
```
1、优化系统瓶颈：通过每条链路上的耗时，我们可以快速定位整个系统的瓶颈所在
2、优化链路调用：分析调用是否每个依赖是否必要，是否可以再次将公共依赖拆分，是否可以通过业务优化减少依赖；实现异地容灾时，服务A调用另一个数据中心的服务B，而没有调用本地数据中心的服务B
3、生成网络拓扑：通过网络拓扑可以反应服务之间的依赖关系，知道服务之间调用关系
4、透明传输数据：进行A/B测试
```
**服务追踪原理**
```
服务追踪原理基本概念术语（traceId、spanId、annonation）
1、traceId用于标识某次请求的id，当用户进入系统后，会在RPC调用第一层生成一个traceId，随着RPC的后续调用traceId会将一次用户的请求在系统调用串联起来
2、spanid用于标识RPC调用分布式请求的位置，初始位置为0，进入下一层调用服务为0.1，若继续下一层RPC调用另外一个服务为0.0.1，这样根据spanid可以知道上下游的位置
3、annotation用于业务自定义埋点数据，可以是业务感兴趣的想上传到后端的数据，比如一次请求的用户 UID
```
## 微服务治理的手段
**节点管理**
```
1、注册中心主动摘除机制，服务提供者主动向注册中心汇报心跳，注册中心根据近一次与上一次进行比较，如果超出一定时间，就认为有故障，继而将节点移除，把最近可用服务提供者节点推送至服务消费者
2、服务消费者摘除机制，若服务消费者与所有服务提供者连接失败，就将这个节点从内存中保存的可用服务提供者节点列表中移除
```
**负载均衡**
```
1、随机算法可用的服务节点中随机选取一个节点
2、轮询算法就是按照固定的权重，对可用服务节点进行轮询
3、最少活跃调用算法每次在选择服务节点时，根据内存里维护的连接数倒序排列，选择连接数最小的节点发起调用，也就是选择了调用量最小的服务节点
4、一致性hash算法指相同参数的请求总是发到同一服务节点。当某一个服务节点出现故障时，原本发往该节点的请求，基于虚拟节点机制，平摊到其他节点上，不会引起剧烈变动
```
**服务路由**
```
1、业务存在灰度发布的需求
2、多机房就近访问需求
```
**服务容灾**
```
1、FailOver：失败自动切换。就是服务消费者发现调用失败或者超时后，自动从可用的服务节点列表总选择下一个节点重新发起调用，也可以设置重试的次数
2、FailBack：失败通知。就是服务消费者调用失败或者超时后，不再重试，而是根据失败的详细信息，来决定后续的执行策略
3、FailCache：失败缓存。就是服务消费者调用失败或者超时后，不立即发起重试，而是隔一段时间后再次尝试发起调用
4、FailFast：快速失败。就是服务消费者调用一次失败后，不再重试。实际在业务执行时，一般非核心业务的调用
```
